define(["jquery","core/log","core/templates","core/notification","core/str","core/modal_factory","mod_tutorialbooking/dragdrop-datastore"],function(a,b,c,d,e,f,g){var h={DRAGGED:"dimmed",DRAGOVER:"well",HANDLE:"draghandle"},i={DATANODE:".datanode",DRAGGABLE:".draggable",DRAGAREA:".dragarea",DROPTARGET:".droppable",HANDLEELEMENT:".draggable .handle"},j={ICON:{name:"i/move_2d",component:"core"},STRING:{name:"moveslot",component:"mod_tutorialbooking"}},k=function(a){g.setKeyboardMenu(a),a.getRoot().on("click","a",v),a.getRoot().on("keydown","a",v),a.show(),b.debug("Menu attached","mod_tutorialbooking/dragdrop-base")},l=function(){b.debug("Close menu","mod_tutorialbooking/dragdrop-base");var a=g.getKeyboardMenu();a.getRoot().off("click","a",v),a.getRoot().off("keydown","a",v),a.hide(),g.setKeyboardMenu(null),a.destroy()},m=function(){var b=this.SELECTORS.HANDLEELEMENT,f=this.CSS.HANDLE;a(b).css("cursor","move");var g=this.HANDLE.ICON;return e.get_string(this.HANDLE.STRING.name,this.HANDLE.STRING.component).then(function(a){return c.render("mod_tutorialbooking/dragicon",{icon:g,text:a,classes:f})}).then(function(c){a(b).prepend(a(c)),a("img",b).css("cursor","move")}).fail(d.exception)},n=function(a){var b=Array.prototype.slice.call(arguments,1),d=c.render("mod_tutorialbooking/keyboardmenu",{links:b});return f.create({title:a,body:d})},o=function(b){var c=a(b.target).closest(b.data.selectors.HANDLEELEMENT+" ."+b.data.css.HANDLE);0!==c.length&&z(b)},p=function(c){b.debug("Drag ended","mod_tutorialbooking/dragdrop-base");var d=a("#"+g.getDragged());d.removeClass(c.data.css.DRAGGED),d.each(x),a(c.data.selectors.DRAGGABLE).removeClass(c.data.css.DRAGOVER),c.data.handler.dragEnd(c)},q=function(b){var c=a(b.target).closest(b.data.selectors.DROPTARGET);c.removeClass(b.data.css.DRAGOVER),b.data.handler.dragLeave(b)},r=function(b){var c=a(b.target).closest(b.data.selectors.DROPTARGET);b.preventDefault(),c.addClass(b.data.css.DRAGOVER),b.data.handler.dragOver(b)},s=function(c){var d=a(c.target).closest(c.data.selectors.DRAGGABLE);b.debug("Drag started","mod_tutorialbooking/dragdrop-base"),g.clearAll(),g.setDragged(d.attr("id")),d.each(A),d.addClass(c.data.css.DRAGGED),c.data.handler.dragStart(c)},t=function(c){var d=a(c.target).closest(c.data.selectors.DROPTARGET);b.debug("Dropped element","mod_tutorialbooking/dragdrop-base"),c.preventDefault(),g.setTarget(d.attr("id")),c.data.handler.drop(c)},u=function(a){13!==a.which&&32!==a.which||z(a)},v=function(c){if(27===c.which)return void l();var d=a(c.target).closest(".dragdrop-keyboard-drag a");0!==d.length&&(13!==c.which&&32!==c.which&&"click"!==c.type||(g.setTarget(a(c.target).data("drop-target")),b.debug("Menu link activated for "+g.getTarget(),"mod_tutorialbooking/dragdrop-base"),l(),a("#"+g.getTarget()).trigger("drop")))},w=function(){b.debug("Setting up","mod_tutorialbooking/dragdrop-base"),this.createHandles();var c=a(this.SELECTORS.DRAGAREA),d={css:this.CSS,selectors:this.SELECTORS,handler:this};c.on("dragend",d,this.globalDragEnd),c.on("dragleave",this.SELECTORS.DROPTARGET,d,this.globalDragLeave),c.on("dragover",this.SELECTORS.DROPTARGET,d,this.globalDragOver),c.on("dragstart",this.SELECTORS.DRAGGABLE,d,this.globalDragStart),c.on("drop",this.SELECTORS.DROPTARGET,d,this.globalDrop),c.on("keydown",this.SELECTORS.HANDLEELEMENT+" ."+this.CSS.HANDLE,d,this.globalKeyDown),c.on("click",this.SELECTORS.HANDLEELEMENT+" ."+this.CSS.HANDLE,d,this.globalClick),a(this.SELECTORS.DRAGGABLE).each(x),b.debug("Setup completed","mod_tutorialbooking/dragdrop-base")},x=function(b,c){a(c).attr("draggable","true")},y=function(){},z=function(c){b.debug("Open menu","mod_tutorialbooking/dragdrop-base"),g.clearAll();var d=[],f=a(c.target).closest(c.data.selectors.DRAGGABLE).first();g.setDragged(f.attr("id"));var h=a(c.target).closest(c.data.selectors.HANDLEELEMENT).first().text();d.push(e.get_string("movecontent","core",h));var i="tocontent",j="core";a(c.data.selectors.HANDLEELEMENT).each(function(b,g){var h=a(g).closest(c.data.selectors.DRAGGABLE);if(!h.is(f)){var k=e.get_string(i,j,a(g).text()).then(function(a){return{name:a,target:h.attr("id")}});d.push(k)}});var l=a.when.apply(this,d);l.then(n).then(k)},A=function(b,c){a(c).attr("draggable",null)};return{CSS:h,SELECTORS:i,HANDLE:j,createHandles:m,globalClick:o,globalDragEnd:p,globalDragLeave:q,globalDragOver:r,globalDragStart:s,globalDrop:t,globalKeyDown:u,globalSetup:w,dragEnd:y,dragLeave:y,dragOver:y,dragStart:y,drop:y}});